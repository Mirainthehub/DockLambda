name: Package Unsigned DockLambda

# è§¦å‘æ¡ä»¶
on:
  # Push åˆ°ä¸»åˆ†æ”¯æ—¶æž„å»º
  push:
    branches: [ main, master ]
    paths:
      - 'DockLambda/**'
      - 'DockLambda.xcodeproj/**'
      - 'scripts/package_unsigned.sh'
      - '.github/workflows/package-unsigned.yml'
  
  # åˆ›å»º Release æ—¶æž„å»º
  release:
    types: [created, published]
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      create_release:
        description: 'æ˜¯å¦åˆ›å»º GitHub Release'
        required: false
        default: false
        type: boolean
      release_tag:
        description: 'Release æ ‡ç­¾ (ä»…åœ¨åˆ›å»º Release æ—¶éœ€è¦)'
        required: false
        default: ''
        type: string

# çŽ¯å¢ƒå˜é‡
env:
  SCHEME: DockLambda
  CONFIGURATION: Release
  APP_NAME: DockLambda.app
  ZIP_NAME: DockLambda-macOS.zip

jobs:
  build-unsigned:
    name: æž„å»ºæœªç­¾åç‰ˆæœ¬
    runs-on: macos-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸŽ è®¾ç½® Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: ðŸ” æ˜¾ç¤ºæž„å»ºçŽ¯å¢ƒä¿¡æ¯
      run: |
        echo "ðŸ–¥ï¸  macOS ç‰ˆæœ¬: $(sw_vers -productVersion)"
        echo "ðŸ”¨ Xcode ç‰ˆæœ¬: $(xcodebuild -version)"
        echo "ðŸ’» æž¶æž„: $(uname -m)"
        echo "ðŸ“ å·¥ä½œç›®å½•: $(pwd)"
    
    - name: ðŸ“‹ éªŒè¯é¡¹ç›®é…ç½®
      run: |
        echo "ðŸ” æ£€æŸ¥é¡¹ç›®æ–‡ä»¶..."
        ls -la DockLambda.xcodeproj/
        
        echo "ðŸŽ¯ æ£€æŸ¥ Scheme..."
        xcodebuild -list -project DockLambda.xcodeproj
    
    - name: ðŸ§¹ æ¸…ç†æž„å»ºç›®å½•
      run: |
        rm -rf build/
        rm -rf DerivedData/
    
    - name: ðŸ”¨ æž„å»º Archive
      run: |
        echo "ðŸš€ å¼€å§‹æž„å»º Archive..."
        
        # å…ˆå°è¯•åŸºæœ¬æž„å»ºæµ‹è¯•
        echo "ðŸ§ª æµ‹è¯•åŸºç¡€æž„å»º..."
        if ! xcodebuild \
          -scheme "$SCHEME" \
          -configuration "$CONFIGURATION" \
          -destination "generic/platform=macOS" \
          build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          PRODUCT_BUNDLE_IDENTIFIER="com.example.DockLambda"; then
          
          echo "âŒ åŸºç¡€æž„å»ºå¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯..."
          exit 1
        fi
        
        echo "âœ… åŸºç¡€æž„å»ºæˆåŠŸï¼Œå¼€å§‹ Archive..."
        
        xcodebuild archive \
          -scheme "$SCHEME" \
          -configuration "$CONFIGURATION" \
          -destination "generic/platform=macOS" \
          -archivePath "build/DockLambda.xcarchive" \
          -allowProvisioningUpdates \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          BUILD_DIR="$(pwd)/build" \
          PRODUCT_BUNDLE_IDENTIFIER="com.example.DockLambda"
        
        echo "âœ… Archive æž„å»ºå®Œæˆ"
        ls -la build/DockLambda.xcarchive/
    
    - name: ðŸ“¤ å¯¼å‡ºåº”ç”¨
      run: |
        echo "ðŸ“¤ å¯¼å‡º .app æ–‡ä»¶..."
        
        # åˆ›å»ºå¯¼å‡ºç›®å½•
        mkdir -p build/ReleaseUnsigned
        
        # ç›´æŽ¥ä½¿ç”¨å…œåº•æ–¹æ¡ˆï¼ˆä»Ž Archive å¤åˆ¶ï¼‰ï¼Œå› ä¸º exportArchive åœ¨æ— ç­¾åæ—¶ç»å¸¸å¤±è´¥
        echo "âš ï¸  è·³è¿‡ exportArchiveï¼Œç›´æŽ¥ä½¿ç”¨å…œåº•å¤åˆ¶æ–¹æ¡ˆï¼ˆæ›´å¯é ï¼‰..."
        
        # ç›´æŽ¥ä»Ž archive å¤åˆ¶
        ARCHIVE_APP_PATH="build/DockLambda.xcarchive/Products/Applications/$APP_NAME"
        
        if [ -d "$ARCHIVE_APP_PATH" ]; then
          cp -R "$ARCHIVE_APP_PATH" build/ReleaseUnsigned/
          echo "âœ… ä½¿ç”¨å…œåº•æ–¹æ¡ˆå¤åˆ¶æˆåŠŸ"
        else
          echo "âŒ Archive ä¸­æœªæ‰¾åˆ°åº”ç”¨"
          echo "ðŸ” æŸ¥çœ‹ Archive ç»“æž„ï¼š"
          find build/DockLambda.xcarchive -name "*.app" -type d
          exit 1
        fi
        
        # éªŒè¯å¯¼å‡ºç»“æžœ
        if [ ! -d "build/ReleaseUnsigned/$APP_NAME" ]; then
          echo "âŒ åº”ç”¨å¯¼å‡ºå¤±è´¥"
          exit 1
        fi
        
        echo "âœ… åº”ç”¨å¯¼å‡ºæˆåŠŸ"
        ls -la build/ReleaseUnsigned/
    
    - name: ðŸ“¦ åˆ›å»º ZIP åŒ…
      run: |
        echo "ðŸ“¦ åˆ›å»º ZIP åŽ‹ç¼©åŒ…..."
        
        cd build/ReleaseUnsigned
        
        # ç¡®è®¤åº”ç”¨å­˜åœ¨
        if [ ! -d "$APP_NAME" ]; then
          echo "âŒ æœªæ‰¾åˆ°åº”ç”¨æ–‡ä»¶"
          exit 1
        fi
        
        # åˆ›å»º ZIPï¼ˆæŽ’é™¤ç³»ç»Ÿæ–‡ä»¶ï¼‰
        zip -r "$ZIP_NAME" "$APP_NAME" -x "*.DS_Store"
        
        # éªŒè¯ ZIP
        if [ ! -f "$ZIP_NAME" ]; then
          echo "âŒ ZIP åˆ›å»ºå¤±è´¥"
          exit 1
        fi
        
        echo "âœ… ZIP åˆ›å»ºæˆåŠŸ"
        ls -lah "$ZIP_NAME"
        
        # æ˜¾ç¤º ZIP å†…å®¹
        echo "ðŸ“‹ ZIP å†…å®¹ï¼š"
        unzip -l "$ZIP_NAME"
    
    - name: ðŸ“Š æž„å»ºä¿¡æ¯æ±‡æ€»
      run: |
        echo "ðŸŽ‰ æž„å»ºå®Œæˆï¼"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        ZIP_PATH="build/ReleaseUnsigned/$ZIP_NAME"
        ZIP_SIZE=$(du -h "$ZIP_PATH" | cut -f1)
        
        echo "ðŸ“¦ ZIP æ–‡ä»¶: $ZIP_PATH"
        echo "ðŸ“ æ–‡ä»¶å¤§å°: $ZIP_SIZE"
        echo "ðŸ—ï¸  æž„å»ºé…ç½®: $CONFIGURATION"
        echo "ðŸŽ¯ Bundle ID: com.example.DockLambda"
        echo "ðŸ–¥ï¸  ç›®æ ‡ç³»ç»Ÿ: macOS 13.0+"
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "zip_path=$ZIP_PATH" >> $GITHUB_OUTPUT
        echo "zip_size=$ZIP_SIZE" >> $GITHUB_OUTPUT
    
    - name: â¬†ï¸ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: DockLambda-macOS-unsigned
        path: build/ReleaseUnsigned/${{ env.ZIP_NAME }}
        retention-days: 30
        compression-level: 0  # ZIP å·²åŽ‹ç¼©ï¼Œè·³è¿‡é¢å¤–åŽ‹ç¼©
    
    # å¯é€‰ï¼šåˆ›å»º GitHub Releaseï¼ˆä»…åœ¨æ‰‹åŠ¨è§¦å‘ä¸”æŒ‡å®šæ—¶ï¼‰
    - name: ðŸš€ åˆ›å»º GitHub Release
      if: ${{ github.event.inputs.create_release == 'true' && github.event.inputs.release_tag != '' }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG="${{ github.event.inputs.release_tag }}"
        ZIP_PATH="build/ReleaseUnsigned/$ZIP_NAME"
        
        echo "ðŸš€ åˆ›å»º Release: $TAG"
        
        # ç”Ÿæˆ Release è¯´æ˜Ž
        cat > release_notes.md << 'EOF'
        ðŸ¾ DockLambda $TAG
        
        **æœªç­¾åæµ‹è¯•ç‰ˆæœ¬** - ä»…ç”¨äºŽæµ‹è¯•å’Œå°èŒƒå›´åˆ†å‘
        
        ## ðŸ“¥ å®‰è£…è¯´æ˜Ž
        
        1. ä¸‹è½½ `DockLambda-macOS.zip`
        2. è§£åŽ‹å¹¶æ‹–å…¥ `/Applications` ç›®å½•
        3. é¦–æ¬¡æ‰“å¼€æ—¶å³é”®é€‰æ‹©"æ‰“å¼€"ç»•è¿‡ Gatekeeper
        
        ## âš ï¸ é‡è¦æç¤º
        
        - æ­¤ä¸ºæœªç­¾å/æœªå…¬è¯ç‰ˆæœ¬
        - ä»…é€‚ç”¨äºŽæµ‹è¯•çŽ¯å¢ƒ
        - æ­£å¼åˆ†å‘è¯·ä½¿ç”¨ Developer ID ç­¾åç‰ˆæœ¬
        
        ## ðŸ”§ ç³»ç»Ÿè¦æ±‚
        
        - macOS 13.0 æˆ–æ›´é«˜ç‰ˆæœ¬
        - æ”¯æŒ Intel å’Œ Apple Silicon Mac
        
        ---
        
        æž„å»ºä¿¡æ¯ï¼š
        - æž„å»ºæ—¶é—´ï¼š$(date)
        - æäº¤ï¼š${{ github.sha }}
        - å·¥ä½œæµï¼š${{ github.run_id }}
        EOF
        
        # åˆ›å»º Release
        gh release create "$TAG" "$ZIP_PATH" \
          --title "DockLambda $TAG" \
          --notes-file release_notes.md \
          --draft=false \
          --prerelease=true
        
        echo "âœ… Release åˆ›å»ºå®Œæˆ"
        gh release view "$TAG"

    # è¾“å‡ºå·¥ä½œæµç»“æžœ
    - name: ðŸ“‹ å·¥ä½œæµæ€»ç»“
      run: |
        echo "## ðŸŽ¯ æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ“¦ äº§ç‰©åç§°**: DockLambda-macOS-unsigned" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ“ æ–‡ä»¶å¤§å°**: $(du -h build/ReleaseUnsigned/$ZIP_NAME | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ—ï¸  æž„å»ºé…ç½®**: $CONFIGURATION" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ–¥ï¸  ç›®æ ‡ç³»ç»Ÿ**: macOS 13.0+" >> $GITHUB_STEP_SUMMARY
        echo "- **â° æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä¸‹è½½æ–¹å¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. å‰å¾€ [Actions é¡µé¢](../../actions)" >> $GITHUB_STEP_SUMMARY
        echo "2. é€‰æ‹©æ­¤æ¬¡å·¥ä½œæµè¿è¡Œ" >> $GITHUB_STEP_SUMMARY
        echo "3. ä¸‹è½½ **DockLambda-macOS-unsigned** artifact" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ å®‰è£…æç¤º" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- æ­¤ä¸ºæœªç­¾åç‰ˆæœ¬ï¼Œé¦–æ¬¡è¿è¡Œéœ€å³é”®é€‰æ‹©\"æ‰“å¼€\"" >> $GITHUB_STEP_SUMMARY
        echo "- ä»…é€‚ç”¨äºŽæµ‹è¯•å’Œå†…éƒ¨åˆ†å‘" >> $GITHUB_STEP_SUMMARY
        echo "- éœ€è¦ macOS 13.0 æˆ–æ›´é«˜ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY