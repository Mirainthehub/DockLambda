name: Simple Build Test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: åˆ›å»ºæœ€å°æµ‹è¯•é¡¹ç›®
      run: |
        # åˆ›å»ºä¸€ä¸ªæœ€å°çš„ Swift æ–‡ä»¶æ¥æµ‹è¯•åŸºæœ¬ç¼–è¯‘
        mkdir TestApp
        cd TestApp
        
        # åˆ›å»ºåŸºæœ¬çš„ main.swift
        cat > main.swift << 'EOF'
        import Cocoa
        import SpriteKit
        import ServiceManagement
        
        @main
        struct TestApp {
            static func main() {
                print("Hello, macOS!")
            }
        }
        EOF
        
        # å°è¯•ç¼–è¯‘
        echo "ðŸ§ª æµ‹è¯•åŸºæœ¬ç¼–è¯‘..."
        swift main.swift -o test_app -target x86_64-apple-macos13.0
        
        echo "âœ… åŸºæœ¬ç¼–è¯‘æˆåŠŸ"
    
    - name: æµ‹è¯• SMAppService å¯ç”¨æ€§
      run: |
        cat > test_smappservice.swift << 'EOF'
        import Foundation
        import ServiceManagement
        
        @available(macOS 13.0, *)
        class TestSMAppService {
            func test() {
                let service = SMAppService.mainApp
                print("SMAppService status: \(service.status)")
            }
        }
        
        if #available(macOS 13.0, *) {
            let test = TestSMAppService()
            test.test()
            print("âœ… SMAppService test passed")
        } else {
            print("âš ï¸ macOS version too old for SMAppService")
        }
        EOF
        
        swift test_smappservice.swift -target x86_64-apple-macos13.0
    
    - name: é€ä¸ªæµ‹è¯• DockLambda æ–‡ä»¶
      run: |
        echo "ðŸ” æµ‹è¯•å„ä¸ª Swift æ–‡ä»¶..."
        
        # æµ‹è¯•ä¸ä¾èµ–å…¶ä»–æ–‡ä»¶çš„ Swift æ–‡ä»¶
        test_files=(
          "DockLambda/PetStateMachine.swift"
          "DockLambda/DockObserver.swift"
          "DockLambda/StartAtLoginHelper.swift"
        )
        
        for file in "${test_files[@]}"; do
          if [ -f "$file" ]; then
            echo "ðŸ§ª æµ‹è¯•: $file"
            # åŸºæœ¬è¯­æ³•æ£€æŸ¥
            swift -frontend -parse "$file" -sdk $(xcrun --show-sdk-path --sdk macosx) -target x86_64-apple-macos13.0 || {
              echo "âŒ è¯­æ³•é”™è¯¯åœ¨: $file"
              exit 1
            }
            echo "âœ… $file è¯­æ³•æ­£ç¡®"
          fi
        done
    
    - name: æ£€æŸ¥ Xcode é¡¹ç›®é…ç½®
      run: |
        echo "ðŸ” æ£€æŸ¥ Xcode é¡¹ç›®è®¾ç½®..."
        
        # æå–å…³é”®è®¾ç½®
        grep -A 5 -B 5 "SWIFT_VERSION\|MACOSX_DEPLOYMENT_TARGET\|PRODUCT_BUNDLE_IDENTIFIER" DockLambda.xcodeproj/project.pbxproj || true
        
        echo "ðŸ“‹ æ˜¾ç¤ºå®Œæ•´çš„æž„å»ºè®¾ç½®..."
        xcodebuild -project DockLambda.xcodeproj -target DockLambda -showBuildSettings | head -50